<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ÙƒØ´Ù Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>

<style>
  :root{--brand:#0f5c6e;}
  body{font-family: Tahoma, Arial, sans-serif; background:#f7f7f7; padding:20px; margin:0;}
  .card{max-width:1000px;margin:0 auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px;}
  h2{margin:0 0 10px 0;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  input[type="text"]{padding:12px 14px;min-width:280px;border:1px solid #ddd;border-radius:10px;font-size:16px;outline:none}
  input[type="text"]:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(15,92,110,.15)}
  .note{color:#666;margin-top:10px;text-align:center}
  .pill{display:inline-block;background:rgba(15,92,110,.08);color:var(--brand);padding:6px 10px;border-radius:999px;font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff}
  th,td{border:1px solid #e2e2e2;padding:10px;text-align:right;vertical-align:top}
  th{background:var(--brand);color:#fff;position:sticky;top:0}
  tr:nth-child(even){background:#fafafa}
  .actions{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
  .btn2{background:#eee}
  .small{font-size:12px;color:#777;text-align:center;margin-top:8px}
  .hidden{display:none}
</style>
</head>

<body>
  <div class="card">
    <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h2>

    <div class="row">
      <input id="search" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ù„ÙŠ)" autocomplete="off" />
      <!-- ØªÙ… Ø¥Ø®ÙØ§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    </div>

    <div class="note" id="info">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div class="actions">
      <button class="btn2" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
      <button class="btn2" id="printBtn" type="button">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
    </div>

    <table id="table" class="hidden">
      <thead></thead>
      <tbody></tbody>
    </table>

    <div class="small">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ù„Ù ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„Ø§ ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø±ÙØ¹Ù‡.
    </div>
  </div>

<script>
let data = [];
let headers = [];
let FAMILY_COL = null;

const info = document.getElementById("info");
const table = document.getElementById("table");
const thead = table.querySelector("thead");
const tbody = table.querySelector("tbody");
const searchInput = document.getElementById("search");

const norm = s => (s ?? "")
  .toString()
  .replace(/[\u064B-\u0652]/g, "")     // remove Arabic diacritics
  .trim()
  .replace(/\s+/g, " ")
  .toLowerCase();

function detectSeparator(line){
  const comma = (line.match(/,/g) || []).length;
  const semi  = (line.match(/;/g) || []).length;
  return semi > comma ? ";" : ",";
}

function splitCSVLine(line, sep){
  const res = [];
  let cur = "", inQ = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"'){
      if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === sep && !inQ){
      res.push(cur);
      cur = "";
    } else {
      cur += ch;
    }
  }
  res.push(cur);
  return res.map(v => v.trim());
}

function parseCSV(text){
  text = text.replace(/\r/g,"").trim();
  const lines = text.split("\n").filter(l => l.trim() !== "");
  if (!lines.length) return {headers:[], rows:[]};

  const sep = detectSeparator(lines[0]);
  headers = splitCSVLine(lines[0], sep).map(h => h.trim());

  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i], sep);
    const obj = {};
    headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
    rows.push(obj);
  }
  return {headers, rows};
}

function detectFamilyColumn(){
  const candidates = [
    "Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",
    "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©",
    "Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ù‡",
    "Ø§Ù„Ø¹Ø§Ø¦Ù„Ù‡",
    "Family",
    "family",
    "LastName",
    "last_name",
    "surname"
  ];
  for (const c of candidates){
    const found = headers.find(h => h.trim() === c);
    if (found) return found;
  }
  const fuzzy = headers.find(h => h.includes("Ø¹Ø§Ø¦Ù„"));
  if (fuzzy) return fuzzy;

  const fuzzyEn = headers.find(h => h.toLowerCase().includes("family") || h.toLowerCase().includes("surname") || h.toLowerCase().includes("last"));
  return fuzzyEn || null;
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderTable(rows){
  if (!rows.length){
    table.classList.add("hidden");
    return;
  }
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${escapeHtml(h)}</th>`).join("") + "</tr>";
  tbody.innerHTML = rows.map(r => "<tr>" + headers.map(h => `<td>${escapeHtml(r[h] ?? "")}</td>`).join("") + "</tr>").join("");
  table.classList.remove("hidden");
}

function search(){
  const q = norm(searchInput.value);

  if (!data.length){
    info.textContent = "âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯. Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©...";
    renderTable([]);
    return;
  }

  if (!FAMILY_COL){
    info.textContent = "âš ï¸ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…ÙˆØ¯ (Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©) Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    renderTable([]);
    return;
  }

  if (!q){
    info.innerHTML = `Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø© âœ”ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù„Ù„Ø¨Ø­Ø«. <span class="pill">Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø­Ø«: ${escapeHtml(FAMILY_COL)}</span>`;
    renderTable([]);
    return;
  }

  const res = data.filter(r => norm(r[FAMILY_COL]).includes(q));
  if (!res.length){
    info.innerHTML = `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. <span class="pill">Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø­Ø«: ${escapeHtml(FAMILY_COL)}</span>`;
    renderTable([]);
    return;
  }

  info.innerHTML = `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${res.length} <span class="pill">Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø­Ø«: ${escapeHtml(FAMILY_COL)}</span>`;
  renderTable(res);
}

/* âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ + Ù…Ù†Ø¹ Ø§Ù„ÙƒØ§Ø´ */
fetch("families.csv?v=" + Date.now())
  .then(r => {
    if (!r.ok) throw new Error("families.csv not found");
    return r.text();
  })
  .then(text => {
    const parsed = parseCSV(text);
    data = parsed.rows;
    FAMILY_COL = detectFamilyColumn();

    if (!data.length){
      info.textContent = "âš ï¸ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡. Ø§Ø­ÙØ¸Ù‡ CSV (UTF-8) Ù…Ù† Excel.";
      return;
    }
    if (!FAMILY_COL){
      info.textContent = "âš ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„ÙƒÙ† Ù„Ù… Ø£Ø¬Ø¯ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©. Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.";
      return;
    }
    search();
  })
  .catch(err => {
    info.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (families.csv). ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…Ø±ÙÙˆØ¹ Ø¨Ø¬Ø§Ù†Ø¨ index.html.";
    console.error(err);
  });

searchInput.addEventListener("input", search);

document.getElementById("clearBtn").addEventListener("click", ()=>{
  searchInput.value = "";
  search();
  searchInput.focus();
});

document.getElementById("printBtn").addEventListener("click", ()=>{
  if (table.classList.contains("hidden")){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");
    return;
  }
  window.print();
});
</script>

</body>
</html>
